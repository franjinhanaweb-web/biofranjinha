rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== REGRAS PARA CÓDIGOS DE VERIFICAÇÃO =====
    match /Codes_biosite/{codeId} {
      // Permitir leitura para todos (validação de códigos)
      allow read: if true;
      
      // Permitir criação apenas por usuários autenticados
      allow create: if request.auth != null;
      
      // Permitir atualização apenas para marcar como usado
      allow update: if request.resource.data.keys().hasAll(['code', 'isUsed'])
        && request.resource.data.code == resource.data.code
        && (resource.data.isUsed == false || resource.data.isUsed == 'false')
        && (request.resource.data.isUsed == true || request.resource.data.isUsed == 'true');
      
      // Não permitir deleção
      allow delete: if false;
    }
    
    // ===== REGRAS PARA USUÁRIOS =====
    match /users/{userId} {
      // Permitir leitura para verificar email duplicado
      allow read: if true;
      
      // Permitir criação apenas durante registro (usuário autenticado)
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Permitir escrita apenas pelo próprio usuário
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ===== REGRAS PARA USUÁRIOS DO SITE =====
    match /Usuarios_biosite/{userId} {
      // Permitir leitura para verificar email duplicado
      allow read: if true;
      
      // Permitir criação apenas durante registro (usuário autenticado)
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Permitir atualização apenas pelo próprio usuário
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Permitir escrita (create + update) apenas pelo próprio usuário
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ===== REGRAS PADRÃO =====
    // Negar acesso a todas as outras coleções
    match /{document=**} {
      allow read, write: if false;
    }
  }
}