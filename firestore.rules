rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ===== REGRAS PARA CÓDIGOS DE CONVITE =====
    match /codes/{codeId} {
      // Permitir leitura para todos (necessário para validação de códigos)
      allow read: if true;
      
      // Permitir escrita apenas para usuários autenticados com App Check
      allow write: if request.auth != null && true;
      
      // Permitir atualização para marcar como usado com App Check
      allow update: if request.auth != null && true;
    }
    
    // ===== REGRAS PARA CÓDIGOS DE VERIFICAÇÃO (NOVO PROJETO) =====
    match /users_codes/{codeId} {
      // Permitir leitura para todos (necessário para validação de códigos)
      allow read: if true;
      
      // Permitir escrita apenas para usuários autenticados com App Check
      allow write: if request.auth != null && true;
      
      // Permitir atualização para marcar como usado com App Check
      allow update: if request.auth != null && true;
    }
    
    // ===== REGRAS PARA PROGRESSO DO USUÁRIO =====
    match /userProgress/{progressId} {
      // Permitir leitura apenas pelo próprio usuário com App Check
      allow read: if request.auth != null && 
                   request.auth.uid == resource.data.userId &&
                   true;
      
      // Permitir escrita apenas pelo próprio usuário com App Check
      allow write: if request.auth != null && 
                   request.auth.uid == resource.data.userId &&
                   true;
      
      // Permitir criação se o userId corresponder ao usuário autenticado com App Check
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId &&
                   true;
    }
    
    // ===== REGRAS PARA USUÁRIOS =====
    match /users/{userId} {
      // Permitir leitura para verificar email duplicado durante registro (SEM App Check para compatibilidade)
      allow read: if true;
      
      // Permitir escrita apenas pelo próprio usuário com App Check
      allow write: if request.auth != null && 
                   request.auth.uid == userId &&
                   true;
      
      // Permitir criação durante registro (usuário ainda não autenticado)
      allow create: if true;
    }
    
    // ===== REGRAS PARA TESTES DE APP CHECK =====
    match /appcheck_test/{document=**} {
      // Coleção específica para testes - EXIGE App Check em todas as operações
      allow read, write: if true;
    }
    
    // ===== REGRAS PARA CONTEÚDO DA MENTORIA =====
    match /mentoriaContent/{contentId} {
      // Permitir leitura para usuários autenticados com App Check
      allow read: if request.auth != null && true;
      
      // Permitir escrita apenas para administradores
      allow write: if false; // Desabilitado por padrão
    }
    
    // ===== REGRAS PARA USUARIOS_BIOSITE (COLEÇÃO PRINCIPAL) =====
    match /Usuarios_biosite/{userId} {
      // EXIGE App Check para TODAS as operações
      allow read, write: if request.auth != null 
        && request.auth.uid == userId
        && true;
    }
    
    // ===== REGRAS PARA TESTES DE APP CHECK =====
    match /appcheck_test/{document=**} {
      // Coleção específica para testes - EXIGE App Check em todas as operações
      allow read, write: if true;
    }
    
    // ===== REGRAS PARA USERS_SITE (NOVO PROJETO) =====
    match /users_site/{userId} {
      // Apenas o próprio usuário pode ler/escrever seus dados com App Check
      allow read, write: if request.auth != null 
        && request.auth.uid == userId
        && true;
    }
    
    // ===== REGRAS PADRÃO =====
    // Negar acesso a todas as outras coleções por padrão
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

